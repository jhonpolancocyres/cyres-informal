{% extends "layout.html" %}

{% block content %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    :root { --slate-50: #f8fafc; --slate-100: #f1f5f9; --slate-600: #475569; --slate-900: #0f172a; --blue-600: #2563eb; }
    .dashboard-container { background-color: var(--slate-50); padding: 1.5rem 2rem; min-height: 100vh; font-family: 'Inter', sans-serif; }
    .header-metrics { background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.25rem 2rem; display: flex; align-items: center; gap: 3.5rem; margin-bottom: 2rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .metric-group { display: flex; flex-direction: column; }
    .metric-label { font-size: 0.7rem; font-weight: 700; color: var(--slate-600); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 2px; }
    .metric-value { font-size: 1.6rem; font-weight: 800; color: var(--slate-900); line-height: 1.1; }
    .metric-unit { font-size: 0.75rem; color: #94a3b8; font-weight: 400; margin-left: 4px; }
    .section-spacer { margin-top: 2.5rem; margin-bottom: 1.5rem; }
    .section-title { font-size: 0.85rem; font-weight: 700; color: var(--slate-600); text-transform: uppercase; letter-spacing: 0.1em; display: flex; align-items: center; margin: 0; }
    .section-title::after { content: ""; flex: 1; margin-left: 1.5rem; height: 1px; background: #e2e8f0; }
    .table-container-custom { background: white; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); overflow: hidden; }

    /* Esto iguala la fuente de las tres tablas de ranking */
    .table-container-custom table {
        font-size: 0.85rem !important;
    }

    .table-container-custom thead th {
        font-size: 0.75rem !important;
        font-weight: 700;
    }

    /* Ajuste para las filas de totales */
    .table-container-custom tfoot td {
        font-size: 0.85rem !important;
    }
</style>

<div class="dashboard-container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold mb-0">Tablero de Gestión Integral</h3>
        <span class="badge bg-white text-dark border py-2 px-3 rounded-pill shadow-sm">Corte: {{ now.strftime('%d/%m/%Y %H:%M') }}</span>
    </div>

    <div class="d-flex mb-4">
        <a href="{{ url_for('gestiones', vista='general') }}" 
           class="nav-link rounded-pill px-4 me-2 border {{ 'active bg-primary text-white shadow' if vista_detalle == 'general' else 'bg-light text-dark' }}">
           Cartera General
        </a>
        <a href="{{ url_for('gestiones', vista='analistas') }}" 
           class="nav-link rounded-pill px-4 border {{ 'active bg-primary text-white shadow' if vista_detalle == 'analistas' else 'bg-light text-dark' }}">
           Detalle de Analistas
        </a>
    </div>

    <div class="container-fluid px-0">
        
        {% if vista_detalle == 'general' %}
            <div id="seccion-general" class="animate__animated animate__fadeIn">
                <div class="header-metrics mb-4">
                    <div class="metric-group">
                        <span class="metric-label">Base de Cartera</span>
                        <div><span class="metric-value">{{ "{:,.0f}".format(stats.total_clientes) }}</span><span class="metric-unit">Clientes</span></div>
                    </div>
                    
                    <div class="metric-group">
                        <span class="metric-label">Carga Operativa</span>
                        <div><span class="metric-value text-secondary">{{ "{:,.0f}".format(stats.total_documentos | default(0)) }}</span><span class="metric-unit">Documentos</span></div>
                    </div>
                    <div class="metric-group">
                        <span class="metric-label">Densidad</span>
                        <div><span class="metric-value" style="color: var(--blue-600);">{{ stats.promedio_doc }}</span><span class="metric-unit">Doc/Cli</span></div>
                    </div>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-md-3"><div class="card border-0 shadow-sm rounded-4 bg-primary text-white p-3 h-100"><div class="small opacity-75 fw-bold text-uppercase">Barrido</div><h2 class="fw-bold mb-1">{{ stats.porc_barrido }}%</h2><div class="small">{{ stats.cant_gestionados }} Gestionados</div></div></div>
                    <div class="col-md-3"><div class="card border-0 shadow-sm rounded-4 bg-success text-white p-3 h-100"><div class="small opacity-75 fw-bold text-uppercase">Efectividad</div><h2 class="fw-bold mb-1">{{ stats.porc_contactado }}%</h2><div class="small">{{ stats.cant_efectivos }} Efectivos</div></div></div>
                    <div class="col-md-3"><div class="card border-0 shadow-sm rounded-4 bg-danger text-white p-3 h-100"><div class="small opacity-75 fw-bold text-uppercase">No Efectivos</div><h2 class="fw-bold mb-1">{{ stats.porc_no_contactado }}%</h2><div class="small">Contacto no efectivo</div></div></div>
                    <div class="col-md-3"><div class="card border-0 shadow-sm rounded-4 bg-secondary text-white p-3 h-100"><div class="small opacity-75 fw-bold text-uppercase">Pendiente</div><h2 class="fw-bold mb-1">{{ stats.porc_sin_gestion }}%</h2><div class="small">{{ stats.cant_sin_gestion }} Sin Tocar</div></div></div>
                </div>

                <div class="row g-4 mb-5">
                    <div class="col-md-5">
                        <div class="table-container-custom h-100">
                            <div class="p-3 border-bottom bg-white fw-bold">Distribución por Franja</div>
                            <table class="table table-hover align-middle mb-0" style="font-size: 0.82rem;">
                                <thead class="bg-light">
                                    <tr>
                                        <th class="ps-3">Franja</th>
                                        <th class="text-center">Total</th>
                                        <th class="text-center">Gest.</th>
                                        <th class="text-center">Pend.</th>
                                        <th class="text-center">Efec.</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for f in stats.resumen_franjas %}
                                    <tr>
                                        <td class="ps-3 fw-bold">{{ f['Franja Mora Cyres'] }}</td>
                                        <td class="text-center">{{ f.Total }}</td>
                                        <td class="text-center text-primary fw-bold">{{ f.Gestionados }}</td>
                                        <td class="text-center text-danger">{{ f.Sin_Gestion }}</td>
                                        <td class="text-center text-success fw-bold">{{ f.Efectivo }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="col-md-7">
                        <div class="table-container-custom h-100">
                            <div class="p-3 border-bottom bg-white fw-bold text-primary">Inactividad de Gestión</div>
                            <div class="table-responsive">
                                <table class="table table-sm table-hover mb-0" style="font-size: 0.72rem;">
                                    <thead class="bg-light"><tr><th class="ps-3 py-2">Rango</th>{% for col in stats.matriz_antiguedad.columnas %}<th class="text-center">{{ col }}</th>{% endfor %}</tr></thead>
                                    <tbody>{% for fila in stats.matriz_antiguedad.filas %}<tr class="{% if fila.RANGO_GESTION == 'TOTAL GENERAL' %}bg-dark text-white fw-bold{% endif %}"><td class="ps-3 py-2">{{ fila.RANGO_GESTION }}</td>{% for col in stats.matriz_antiguedad.columnas %}<td class="text-center py-2">{{ "{:,.0f}".format(fila[col]) }}</td>{% endfor %}</tr>{% endfor %}</tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="table-container-custom p-3 bg-white">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="fw-bold mb-0">Datos de Gestión</h6>
                        <div class="d-flex gap-2">
                            <button id="btnExportarExcel" class="btn btn-success shadow-sm">
                                <i class="fas fa-file-excel me-2"></i>Exportar
                            </button>
                            <select id="f-franja" class="form-select form-select-sm rounded-pill"><option value="">Franja: Todas</option>{% for f in stats.resumen_franjas %}<option value="{{ f['Franja Mora Cyres'] }}">{{ f['Franja Mora Cyres'] }}</option>{% endfor %}</select>
                            <select id="f-estado" class="form-select form-select-sm rounded-pill"><option value="">Estado: Todos</option><option value="GESTIONADO">GESTIONADOS</option><option value="SIN GESTIÓN">SIN GESTIÓN</option></select>
                            <select id="f-contacto" class="form-select form-select-sm rounded-pill"><option value="">Contacto: Todos</option><option value="EFECTIVO">EFECTIVOS</option><option value="NO EFECTIVO">NO EFECTIVOS</option></select>
                        </div>
                    </div>
                    <table id="tabla-gestion" class="table table-hover w-100">
                        <thead><tr class="text-muted small"><th>Código</th><th>Nombre</th><th>Franja</th><th>Estado</th><th>Última Gestión</th><th>Inactividad</th><th>Contacto</th><th class="text-end">Saldo</th></tr></thead>
                        <tbody>{% for d in stats.detalle_maestro %}<tr><td>{{ d.ID }}</td><td class="fw-bold">{{ d.NOMBRE }}</td><td>{{ d.FRANJA }}</td><td><span class="badge rounded-pill {{ 'bg-success' if d.ESTADO == 'GESTIONADO' else 'bg-light text-dark border' }}">{{ d.ESTADO }}</span></td><td class="text-muted">{{ d.FECHA_ULTIMA }}</td><td>{{ d.RANGO_INACTIVIDAD }}</td><td>{{ d.CONTACTO }}</td><td class="text-end fw-bold">$ {{ "{:,.0f}".format(d.SALDO | float) }}</td></tr>{% endfor %}</tbody>
                    </table>
                </div>
            </div>

        {% elif vista_detalle == 'analistas' %}
            <div id="seccion-analistas" class="animate__animated animate__fadeIn">
                
                <div class="card-body py-2 mb-3">
                    <form method="GET" action="{{ url_for('gestiones') }}" class="row align-items-center">
                        <input type="hidden" name="vista" value="analistas"> 
                        <div class="col-auto"><label class="small fw-bold text-primary">FILTRAR POR ANALISTA:</label></div>
                        <div class="col-md-4">
                            {# EL FILTRO SIEMPRE MOSTRARA A TODOS PORQUE USA resumen_analistas #}
                            <select id="filtroan alista" name="analista" class="form-select form-select-sm border-primary shadow-sm" onchange="this.form.submit()">
                                <option value="Todos">-- Todo el Equipo --</option>
                                {% for ana in stats.resumen_analistas %}
                                    <option value="{{ ana.USUARIO_GESTION }}" {% if request.args.get('analista') == ana.USUARIO_GESTION %}selected{% endif %}>
                                        {{ ana.USUARIO_GESTION }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </form>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-md-4">
                        <div class="table-container-custom h-100 bg-white p-3 border-top border-4 border-danger">
                            <h6 class="fw-bold text-secondary mb-3 small text-uppercase">Ranking Productividad (Mes)</h6>
                            <div class="table-responsive" style="font-size: 0.85rem;">
                                <table class="table table-sm table-hover align-middle mb-0">
                                    <thead class="bg-light">
                                        <tr style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">
                                            <th>Analista</th>
                                            <th class="text-center">Gestiones</th>
                                            <th class="text-center">Efectividad</th>
                                            <th class="text-center">% Efec.</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for a in stats.resumen_analistas %}
                                        <tr>
                                            <td class="fw-bold small">{{ a.USUARIO_GESTION }}</td>
                                            <td class="text-center small">{{ a.Clientes_Unicos_Dia }}</td>
                                            <td class="text-center small fw-bold text-primary">{{ a.Efectivos }}</td>
                                            <td class="text-center">
                                                {# CAMBIAMOS 'ana' por 'a' PARA QUE COINCIDA CON EL FOR #}
                                                {% if a.Efec_Porc >= 75 %}
                                                    {% set color_clase = "bg-success" %}
                                                {% elif a.Efec_Porc >= 65 %}
                                                    {% set color_clase = "bg-warning text-dark" %}
                                                {% else %}
                                                    {% set color_clase = "bg-danger" %}
                                                {% endif %}

                                                <span class="badge {{ color_clase }}" style="font-size: 0.75rem; min-width: 50px;">
                                                    {{ a.Efec_Porc }}%
                                                </span>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="table-container-custom h-100 bg-white p-3 border-top border-4 border-success">
                            <h6 class="fw-bold text-success mb-3 small text-uppercase">Ranking de Recaudo (Mes)</h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-hover align-middle mb-0">
                                    <thead class="bg-light text-success">
                                        <tr class="small">
                                            <th>ANALISTA</th>
                                            <th class="text-end">MONTO</th>
                                            <th class="text-center">%PART.</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {# 1. Calculamos el total de la columna mientras iteramos #}
                                        {% set total_monto = [] %}
                                        
                                        {% for r in stats.recaudo_stats.ranking %}
                                            {% if total_monto.append(r.Total_Recaudado) %}{% endif %}
                                            <tr>
                                                <td class="small fw-bold">{{ r.USUARIO_GESTION }}</td>
                                                <td class="text-end small">${{ "{:,.0f}".format(r.Total_Recaudado) }}</td>
                                                <td class="text-center">
                                                    <span class="badge bg-soft-success text-success" style="font-size: 0.7rem;">{{ r.Porc_Part }}%</span>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                    
                                    {# 2. Añadimos el pie de tabla con los totales #}
                                    <tfoot class="bg-light fw-bold border-top">
                                        <tr>
                                            <td class="small">TOTAL GENERAL</td>
                                            <td class="text-end small">
                                                ${{ "{:,.0f}".format(total_monto | sum) }}
                                            </td>
                                            <td class="text-center small">
                                                <span class="badge bg-success text-white" style="font-size: 0.7rem;">100%</span>
                                            </td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="table-container-custom h-100 bg-white p-3 border-top border-4 border-primary">
                            <h6 class="fw-bold text-primary mb-3 small text-uppercase">Ranking del Día (Hoy)</h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-hover align-middle mb-0">
                                    <thead class="bg-light">
                                        <tr style="font-size: 0.75rem; text-transform: uppercase;">
                                            <th>Analista</th>
                                            <th class="text-center">Clientes</th>
                                            <th class="text-center">Gestiones</th>
                                            <th class="text-center">Efec.</th>
                                            <th class="text-center">%</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for h in stats.ranking_dia %}
                                        <tr>
                                            <td class="fw-bold small">{{ h.USUARIO_GESTION }}</td>
                                            <td class="text-center small">{{ h.clientes_unicos }}</td>
                                            <td class="text-center small text-muted" title="Total de intentos">{{ h.gestiones_totales }}</td>
                                            <td class="text-center small fw-bold text-primary">{{ h.efectivos }}</td>
                                            <td class="text-center">
                                                <span class="badge {{ 'bg-success' if h.porc_efec >= 75 else ('bg-warning text-dark' if h.porc_efec >= 65 else 'bg-danger') }}" 
                                                    style="font-size: 0.75rem; min-width: 50px;">
                                                    {{ h.porc_efec }}%
                                                </span>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-12">
                        <div class="table-container-custom bg-white p-4">
                            <h6 class="fw-bold text-secondary mb-4">Tendencia de Gestión y Calidad (Línea de Tiempo)</h6>
                            <div style="height: 350px; width: 100%;">
                                <canvas id="chartCombinado"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12">
                        <div class="table-container-custom bg-white p-4">
                            <h6 class="fw-bold text-success mb-4 text-uppercase small">Tendencia de Recaudo Diario</h6>
                            <div style="height: 320px;">
                                <canvas id="chartRecaudo"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        if (typeof jQuery !== 'undefined' && document.getElementById('tabla-gestion')) {
        var table = $('#tabla-gestion').DataTable({
            language: { url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json" },
            dom: 'rt', paging: false, info: false, order: [[7, "desc"]]
        });
            $('#f-franja').on('change', function() { table.column(2).search(this.value).draw(); });
            $('#f-estado').on('change', function() { table.column(3).search(this.value).draw(); });
            $('#f-contacto').on('change', function() {
                let val = $.fn.dataTable.util.escapeRegex($(this).val());
                table.column(6).search(val ? '^' + val + '$' : '', true, false).draw();
            });
        }
        
        const canvasComb = document.getElementById('chartCombinado');
        if (canvasComb) {
            new Chart(canvasComb.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: {{ stats.timeline_datos.labels | tojson | safe }},
                    datasets: [
                        { label: 'Clientes Gestionados', data: {{ stats.timeline_datos.gestionados | tojson | safe }}, backgroundColor: 'rgba(37, 99, 235, 0.2)', borderColor: '#2563eb', borderWidth: 1, yAxisID: 'y' },
                        { label: '% Efectividad', data: {{ stats.timeline_datos.efectividad | tojson | safe }}, borderColor: '#10b981', type: 'line', tension: 0.4, yAxisID: 'y1' }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true }, y1: { position: 'right', min: 0, max: 100 } } }
            });
        }

        const ctxRec = document.getElementById('chartRecaudo');
        if (ctxRec) {
            new Chart(ctxRec.getContext('2d'), {
                type: 'line',
                data: {
                    labels: {{ stats.recaudo_stats.labels | tojson | safe }},
                    datasets: [{ label: 'Recaudo ($)', data: {{ stats.recaudo_stats.valores | tojson | safe }}, borderColor: '#10b981', fill: true, backgroundColor: 'rgba(16, 185, 129, 0.1)', tension: 0.3 }]
                },
                options: { maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }
    });

    const btnExportar = document.getElementById('btnExportarExcel');
    if (btnExportar) {
        btnExportar.addEventListener('click', function() {
            const tabla = document.getElementById('tabla-gestion');
            const wb = XLSX.utils.table_to_book(tabla, { sheet: "Gestiones" });
            XLSX.writeFile(wb, `Reporte_Gestion_${new Date().toISOString().slice(0, 10)}.xlsx`);
        });
    }
        document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const seleccionado = urlParams.get('analista');

        if (seleccionado && seleccionado !== 'Todos') {
            // Buscamos todas las filas de la tabla de Recaudo
            // Suponiendo que la tabla es la segunda o tiene una clase específica
            const filas = document.querySelectorAll('table:nth-of-type(2) tbody tr'); 
            
            filas.forEach(fila => {
                const nombreAnalista = fila.cells[0].innerText.trim();
                if (nombreAnalista === seleccionado) {
                    fila.style.backgroundColor = '#e7f1ff'; // Resalta el seleccionado
                    fila.style.display = 'table-row';
                } else {
                    // EN LUGAR DE OCULTAR, solo bajamos la opacidad para que sea ESTÁTICA
                    fila.style.opacity = '0.5'; 
                    fila.style.display = 'table-row'; // Forzamos que se siga viendo
                }
            });
        }
    });
</script>
{% endblock %}